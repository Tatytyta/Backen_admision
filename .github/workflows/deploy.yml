name: Deploy Django to VPS

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]


jobs:
  test:
    runs-on: ubuntu-latest
   
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
   
    steps:
    - uses: actions/checkout@v4
   
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
   
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install setuptools
        pip install -r requirements.txt
   
    - name: Run tests
      env:
        DATABASE_URL: postgres://postgres:postgres@localhost:5432/postgres
        SECRET_KEY: test-secret-key-for-github-actions
        DEBUG: True
        ALLOWED_HOSTS: localhost,127.0.0.1
        DB_ENGINE: django.db.backends.postgresql
        DB_NAME: postgres
        DB_USER: postgres
        DB_PASSWORD: postgres
        DB_HOST: localhost
        DB_PORT: 5432
      run: |
        python manage.py test --verbosity=2


  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
   
    steps:
    - uses: actions/checkout@v4
   
    - name: Install SSH Key
      uses: shimataro/ssh-key-action@v2
      with:
        key: ${{ secrets.VPS_SSH_KEY }}
        known_hosts: 'placeholder'
   
    - name: Adding Known Hosts
      run: ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
   
    - name: Deploy to VPS
      env:
        VPS_HOST: ${{ secrets.VPS_HOST }}
        VPS_USER: ${{ secrets.VPS_USERNAME }}
        PROJECT_PATH: ${{ secrets.PROJECT_PATH }}
        VENV_PATH: ${{ secrets.VENV_PATH }}
      run: |
        ssh -o StrictHostKeyChecking=no $VPS_USER@$VPS_HOST "
          set -e
          
          echo 'üöÄ Iniciando despliegue...'
          echo '================================'
          
          echo '‚úÖ 1. Navegando al directorio del proyecto...'
          cd $PROJECT_PATH
          
          echo '‚úÖ 2. Actualizando c√≥digo desde GitHub...'
          git fetch origin
          git reset --hard origin/main
          git pull origin main
          
          echo '‚úÖ 3. Activando entorno virtual...'
          source $VENV_PATH/bin/activate
          
          echo '‚úÖ 4. Instalando/actualizando dependencias...'
          pip install --upgrade pip
          pip install -r requirements.txt
          
          echo '‚úÖ 5. Aplicando migraciones de base de datos...'
          python manage.py migrate --noinput
          
          echo '‚úÖ 6. Recolectando archivos est√°ticos...'
          python manage.py collectstatic --noinput --clear
          
          echo '‚úÖ 7. Verificando configuraci√≥n de Nginx...'
          sudo nginx -t
          
          echo '‚úÖ 8. Reiniciando Gunicorn...'
          sudo systemctl restart gunicorn
          sudo systemctl status gunicorn --no-pager
          
          echo '‚úÖ 9. Reiniciando Nginx...'
          sudo systemctl restart nginx
          sudo systemctl status nginx --no-pager
          
          echo '================================'
          echo 'üéâ Despliegue completado exitosamente!'
          echo 'üåê Accede a: http://rodriguez-admision-api.desarrollo-software.xyz/admin/'
        "